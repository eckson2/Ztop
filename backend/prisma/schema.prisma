generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  passwordHash  String
  status        String   @default("active") // active, inactive
  role          String   @default("USER")   // ADMIN, USER
  plan          String   @default("free")   // free, pro, enterprise
  webhookToken  String   @unique @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  botConfig      BotConfig?
  whatsappInstance WhatsAppInstance?
  autoTestConfig AutoTestConfig?
  chatSessions   ChatSession[]
  messageLogs    MessageLog[]
}

model AutoTestConfig {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  isEnabled      Boolean  @default(false)
  panelType      String   @default("sigma") // sigma, pfast, koffice, warez
  apiUrl         String   @default("")
  nameField      String   @default("Tops")
  
  // Pfast Config
  pfastToken     String   @default("")
  pfastSecret    String   @default("")
  
  // Stores which fields are enabled to show: { username: true, password: true, dns: true, ... }
  templateFields String   @default("{}") 
  
  // Statistics
  generatedCount Int      @default(0)
  failedCount    Int      @default(0)
  
  updatedAt      DateTime @updatedAt
}

model MessageLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  direction String   // in, out
  type      String   // text, image, etc.
  createdAt DateTime @default(now())
}

model BotConfig {
  id                 String   @id @default(uuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  botType            String?  // dialogflow, typebot
  
  // Dialogflow
  dialogflowProjectId String?
  dialogflowJson     String?  // Criptografado
  dialogflowLang     String   @default("pt-BR")
  
  // Typebot
  typebotId          String?
  typebotToken       String?  // Criptografado
  
  updatedAt          DateTime @updatedAt
}

model WhatsAppInstance {
  id         String   @id @default(uuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  provider   String   // evolution, uazapi
  baseUrl    String
  token      String   // Criptografado
  instanceId String
  status     String   @default("disconnected") // connected, disconnected
  
  updatedAt  DateTime @updatedAt
}

model ChatSession {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  remoteJid      String
  botSessionId   String?  // Para Typebot ou Dialogflow
  lastInteraction DateTime @default(now())

  @@unique([userId, remoteJid])
}
